<!DOCTYPE html> 
    <html> 
    	<head> 
    	<title>My Page</title> 
    	<meta name="viewport" content="width=device-width, initial-scale=1"> 
    	<link rel="stylesheet" href="smoothness/jquery-ui-1.8.20.custom.css" />
    	<link rel="stylesheet" href="jquery.mobile-1.1.0.css" />
    	<script src="jquery-1.7.2.js"></script>
    	<script src="jquery-ui-1.8.20.custom.min.js"></script>
    	<script src="jquery.mobile-1.1.0.js"></script>
    	<script src="plants.json"></script>
    	<link rel="stylesheet" href="garden.css" />
    	
    	<script type="text/javascript">
            var TILE_SIZE = 50;
    	    var plantings, currentPlant, itemTemplate, itemLinkTemplate, itemHeaderTemplate, month, year;
    	    
    	    months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ];
    	    year = 2012;
    	    month = 3;
    	    
    	    // some test data
    	    plantings = [
    	        { areaType: "fill-area", harvestDate: "05/01/2012", plantDate: "04/01/2012", plantingType: "seed", source: "Swanson's", plant: "Carrot", variety: "General", position: { left: 0, top: 0, width: 100, height: 500 }, rating: 3 },
    	        { areaType: "fill-area", harvestDate: "06/01/2012", plantDate: "04/01/2012", plantingType: "seed", source: "Swanson's", plant: "Radish", variety: "Breakfast", position: { left: 0, top: 0, width: 100, height: 500 }, rating: 3 },
    	        { areaType: "single-plant", harvestDate: "09/01/2012", plantDate: "06/01/2012", plantingType: "seed", source: "Swanson's", plant: "Tomato", variety: "Early Girl", position: { left: 100, top: 0, width: 200, height: 200 }, rating: 4 }
    	    ];

    	    var showPlantingDetails = function(planting) {
    	        $("#map .plant-detail-link").text(planting.plant + ", " + planting.variety).unbind("click").click(function () { showPlantingNotes(planting); });
 	            $("#map .planting-date").text(planting.plantDate);
 	            $("#map .harvest-date").text(planting.harvestDate);
 	            $("#map .plant-square-feet").text((planting.position.width * planting.position.height)/2500);
 	            $("#map .planting-details").show();
    	    };
    	    
    	    var changeMonth = function(direction) {
    	        month += direction;
    	        if (month == -1) {
    	            month = 11;
    	            year--;
    	        } else if (month == 12) {
    	            month = 0;
    	            year++;
    	        }
    	        $(".month-selector .month").text(months[month] + " " + year);
    	        
    	        renderPlantMap();
    	    };
    	    
    	    var renderPlantMap = function () {
    	        $("#garden-map").html("");
    	        $(plantings).each(function (idx, planting) { 
    	            if (
    	                ((planting.plantDate.split("/")[2]*100+(planting.plantDate.split("/")[0]-1)) <= (year*100+month)) &&
    	                (!planting.harvestDate || ((planting.harvestDate.split("/")[2]*100+(planting.harvestDate.split("/")[0]-1)) >= (year*100+month)))
    	                ) {
    	                addPlantingToMap(planting);
    	            }
    	        });    	        
    	    };
    	    
    	    var addPlantingToMap = function(planting) {
                // TODO: This should track where plants are in the garden, and
                // not overlap them at the start!
    	        var plant =
                  $(document.createElement("div")).addClass("ui-widget-content").addClass("plant-area").css('background-image',
                      'url("images/' + planting.plant.toLowerCase() + '.png")')
                      .css("width", planting.position ? planting.position.width : 50)
                      .css("height", planting.position ? planting.position.height : 50)
                      .css("left", planting.position ? planting.position.left : 0)
                      .css("top", planting.position ? planting.position.top : 0)
                  .click(function () { showPlantingDetails(planting); });
                $(plant).draggable({
                      // Constrain the dragging to multiples of the tile size.
                      grid: [TILE_SIZE, TILE_SIZE],
                      // Don't drag outside the garden.
                      containment: 'parent',
                      // Bring to the front the most recently clicked item.
                      stack: '#garden-map .plant-area',
                      distance: 0,
                      drag: function (event, ui) {
                          var position = $(this).position();
                          planting.position.top = position.top;
                          planting.position.left = position.left;
                          showPlantingDetails(planting);
                      }
                    })
                $(plant).resizable({
                      // Constrain the resizing to multiples of the tile size.
                      grid: [TILE_SIZE, TILE_SIZE],
                      // Don't resize outside the garden.
                      containment: 'parent',
                      resize: function (event, ui) {
                          planting.position.width = $(this).width();
                          planting.position.height = $(this).height();
                          showPlantingDetails(planting);
                      }
                    });
                // This is set by resizable when resizing, but the default (set
                // by draggable) is relative.  This fixes some DOM reordering
                // when resizing a garden patch for the first time.
                $(plant).css('position', 'absolute');
    	        $("#garden-map").append(plant);
    	    };
    	
    	    var addPlanting = function () {
    	        var form = this;
    	        var planting = {
    	            plant: $(form.plantName).val(),
                    areaType: $(form.addby).val(),
                    plantingType: $(form.plantas).val(),
                    plantDate: $(form.plantDate).val(),
                    harvestDate: $(form.harvestDate).val(),
                    variety: $(form.plantVariety).val(),
                    source: $(form.source).val(),
                    position: { top: 0, left: 0, width: 50, height: 50 }
    	        };
    	        plantings.push(planting);
    	        $.mobile.changePage("#map");
    	        month = planting.plantDate.split("/")[0]-1;
    	        year = planting.plantDate.split("/")[2];
    	        $(".month-selector .month").text(months[month] + " " + year);
    	        renderPlantMap();
    	        return false;
    	    };
    	    
    	    var renderPlantList = function () {
    	        var form = $(".plant-search-form").get(0);
    	        var searchText = $(form['plantName']).val();
    	        var full = $(form.fullSun).attr("checked") == 'checked';
    	        var partial = $(form.partialSun).attr("checked") == 'checked';
    	        var time = $(form.harvestTime).val();
    	        var vert = $(form.spaceVert).val();
    	        var horiz = $(form.spaceHoriz).val();
    	        
    	        $("#search .plant-list li").remove();
    	        var plantList = $("#search .plant-list");
    	        $(plants).each(function (idx, plant) {
    	            if (
        	                (!searchText || plant.name.toLowerCase().indexOf(searchText.toLowerCase()) >= 0) &&
        	                ((full == plant.full) || (partial == plant.partial)) &&
        	                (!time || plant.daysToHarvest <= time) &&
        	                ((!vert || !horiz) || (vert*12 >= plant.diameter && horiz*12 >= plant.diameter))
    	                ) {
    	            
        	            var newPlant = itemLinkTemplate.clone();
        	            
        	            newPlant.find("a").text(plant.name).click(function () { showPlant(plant); });
        	            plantList.append(newPlant);
    	            }
    	        });
    	    };

    	    var showPlant = function (input) {
    	        var currentPlant, selectedVariety;
    	        if (input.plant) {
    	            $(plants).each(function (idx, plant) {
    	                if (plant.name == input.plant) {
    	                    currentPlant = plant;
    	                }
    	            });
    	            selectedVariety = input.variety;
    	        } else {
    	            currentPlant = input;
    	            selectedVariety = currentPlant.varieties[0];
    	        }
    	        
    	        $(".plant-detail-name").text(currentPlant.name);
    	        $(".plant-variety-select").html("");
    	        $(currentPlant.varieties).each(function (idx, variety) {
    	            var option = new Option(variety);
    	            if (variety == selectedVariety) {
    	                $(option).attr("selected", "selected");
    	            }
    	            $(".plant-variety-select").append(option);
    	        });
    	        $("#add [name=plantVariety]").val(selectedVariety);
    	        if (input.plant) {
        	        $("#add [name=plantDate]").val(input.plantDate);
        	        $("#add [name=harvestDate]").val(input.harvestDate);
        	        $("#add [name=source]").val(input.source);
        	        $("#add [name=plantas]").val(input.plantingType);
    	        }
    	        
    	        $("#add [name=plantDate]").change(function () {
    	            var planting, harvest, components;
    	            components = $(this).val().split("/");
    	            planting = new Date(components[2], components[0]-1, components[1], 0, 0, 0, 0);
    	            harvest = new Date(planting.getTime() + currentPlant.daysToHarvest*24*60*60*1000);
    	            $("#add [name=harvestDate]").val((harvest.getMonth() < 9 ? "0" + (harvest.getMonth()+1) : harvest.getMonth()) + "/" + (harvest.getDate() < 10 ? "0" + harvest.getDate() : harvest.getDate()) + "/" + harvest.getFullYear());
    	        });
    	        
    	        $("#add [name=plantName]").val(currentPlant.name);
    	        $.mobile.changePage($("#add"));
    	    };
    	        	    
    	    var renderHistoryList = function () {
    	        var form = $(".history-search-form").get(0);
    	        var year = $(form.year).val();
    	        var searchText = $(form.plantName).val();
    	        
    	        var historyList = $(".history-list").html("");
    	        $(plantings).each(function (idx, planting) {
    	            if (
    	                (!year || planting.plantDate.indexOf(year) >= 0) &&
    	                (!searchText || planting.plant.toLowerCase().indexOf(searchText) >= 0)
    	                ) {
        	            var newPlant = itemLinkTemplate.clone();
        	            var p = $(document.createElement("div"));
        	            p.append($(document.createElement("span")).addClass("plant-history-item-name")
        	                .text(planting.plant + ", " + planting.variety));
        	            p.append($(document.createElement("span")).addClass("plant-history-item-date")
        	                .text(planting.plantDate));
        	            if (planting.rating) {
            	            var stars = $(document.createElement("span")).addClass("plant-history-item-rating");
        	            for (var i = 1; i < 5; i++)
        	                stars.append($(document.createElement("img")).attr("src", i <= planting.rating ? "star-full.png" : "star-empty.png"));
        	                p.append(stars);
    	                }
        	            newPlant.find("a").append(p).click(function () { showPlantingNotes(planting); });
        	            historyList.append(newPlant);
    	            }
    	        });
    	    };
    	    
    	    var showPlantingNotes = function (planting) {
    	        $("#history [name=plantDate]").val(planting.plantDate);
    	        $("#history [name=harvestDate]").val(planting.harvestDate);
    	        $("#history [name=source]").val(planting.source);
    	        $("#history [name=plantas]").val(planting.plantingType);
    	        $("#history [name=rating]").val(planting.rating);
    	        $("#history .plant-name").text(planting.plant);
    	        $("#history [name=plantName]").val(planting.plant);
    	        $("#history .plant-again-link").unbind("click").click(function () { showPlant(planting); });
    	        $("#history .star-rating img:not(gt(" + (planting.rating-1) + "))").attr("src", "star-full.png");
    	        $("#history .star-rating img:gt(" + (planting.rating-1) + ")").attr("src", "star-empty.png");
    	        $.mobile.changePage("#history");
    	    };
    	    
    	    $(document).ready(function () {
    	        
    	        itemTemplate = $(".list-template .list-item-template");
        	    itemLinkTemplate = $(".list-template .list-link-template");
        	    itemHeaderTemplate = $(".list-template .list-header-template");
        	    
    	        $("#plant-date").datepicker();
    	        $("#harvest-date").datepicker();
    	        
    	        $(".add-planting-form").submit(addPlanting);
    	        $("#add .plant-variety-select").change(function () { $("#add [name=plantVariety]").val($(this).val()); });
    	        

    	        $(".plant-search-form input").change(renderPlantList).keyup(renderPlantList);
    	        $(".history-search-form select").change(renderHistoryList);
    	        $(".history-search-form input").change(renderHistoryList).keyup(renderHistoryList);
    	        
    	        $(".month-selector .month").text(months[month] + " " + year);
    	        $(".month-selector .last-month").click(function () { changeMonth(-1); });
    	        $(".month-selector .next-month").click(function () { changeMonth(1); });
    	        
    	        $("#map .search-link").click(function () { $.mobile.changePage("#search");  renderPlantList(); });
    	        $("#map .history-link").click(function () { $.mobile.changePage("#history"); renderHistoryList(); })
    	        $("#map .calendar-link").click(function () { $.mobile.changePage("#calendar"); });
    	        $("#map .layout-tools-link").click(function () { $(".layout-tools").show(); $(".plant-tools").hide() });
    	        $("#map .plant-tools-link").click(function () { $(".plant-tools").show(); $(".layout-tools").hide() });
    	        
    	        $("#history form .star-rating img").click(function () {
    	            var rating = Number($(this).index("#history form .star-rating img"))+1;
    	            $("#history form [name=rating]").val(rating);
        	        $("#history .star-rating img:not(gt(" + (rating-1) + "))").attr("src", "star-full.png");
        	        $("#history .star-rating img:gt(" + (rating-1) + ")").attr("src", "star-empty.png");
    	        });
    	        
    	        renderPlantMap();

    	    });
    	</script>
    	
    </head> 
    <body> 
        
        <div data-role="page" id="map">
            
        	<div data-role="header">
        		<h1>Gardenizer</h1>
        	</div>

        	<div class="header-links" data-role="content" style="text-align: right;">	
        	    <a class="history-link" href="javascript:;" title="View history and record notes"><img src="edit.png" alt="Notes"/></a>
        	    <a class="calendar-link" href="javascript:;" title="View calendar and reminders"><img src="calendar.png" alt="Calendar"/></a>
        	    <a class="plant-tools-link" href="javascript:;">Plant Mode</a>
        	    <a class="layout-tools-link" href="javascript:;">Layout Mode</a>
        	</div>
        	
        	<div id="garden-map">
        	</div>
        	
        	<div id="garden-tools">
        	    <div class="plant-tools">
        	        <a class="search-link" href="javascript:;" data-role="button" data-icon="plus">Add Plants</a>
                	<div class="planting-details" style="display:none">
                	   <h2><a class="plant-detail-link" href="javascript:;">Radish</a></h2>
                	   <p>Planting: <span class="planting-date"></span></p>
                	   <p>Harvest: <span class="harvest-date"></span></p>
                	   <p>Square ft: <span class="plant-square-feet"></span></p>
                	</div>
            	</div>

            	<div class="layout-tools" style="display:none">
            	    <p><a href="javascript:;">Garden Bed</a></p>
            	    <p><a href="javascript:;">Lawn</a></p>
            	    <p><a href="javascript:;">Trees</a></p>
            	    <p><a href="javascript:;">Fence/Trellis</a></p>
            	</div>

        	</div>
        	
        	<div class="month-selector">
        	    <a class="last-month" href="javascript:;">&lt;</a>
        	    <span class="month"></span>
        	    <a class="next-month" href="javascript:;">&gt;</a>
        	    <a href="javascript:alert('Not implemented');" title-"Print Garden Map"><img src="printer.png" alt="Print"/></a>
        	</div>
            <div style="display:none">
                <ul data-role="listview" class="list-template">
                    <li data-role="list-divider" class="list-header-template">header</li>
                    <li class="list-item-template">item</li>
                    <li class="list-link-template"><a href="javascript:;"></a></li>
                </ul>
            </div>

        </div>

        <div data-role="page" id="search">

        	<div data-role="header">
        	    <a href="javascript:;" data-rel="back" data-icon="back">Back</a>
        		<h1>Find Plants</h1>
        	</div><!-- /header -->

        	<div data-role="content">
        	    <div class="ui-grid-a">
            	    <div class="ui-block-a">
                	    <form class="plant-search-form">
                	        <div data-role="fieldcontain">
                        	    <input id="plantName" name="plantName" type="text" data-type="search" placeholder="Plant"/>
                    	    </div>
                    	    <div data-role="fieldcontain">
                        	    <fieldset data-role="controlgroup" data-type="horizontal">
                            	    <input id="full-sun" name="fullSun" type="checkbox" checked="checked"/> 
                            	    <label for="full-sun">Full sun</label>
                            	    <input id="partial-sun" name="partialSun" type="checkbox" checked="checked"/> 
                            	    <label for="partial-sun">Partial sun</label>
                        	    </fieldset>
                    	    </div>
                    	    <div data-role="fieldcontain">
                        	    <label for="harvest-time">Max time to harvest</label>
                        	    <input id="harvest-time" name="harvestTime" type="text" style="width: 3em"/>
                        	    days
                    	    </div>
                    	    <div data-role="fieldcontain">
                    	        <legend>Max space</legend>
                        	    <input id="space-horiz" name="spaceHoriz" type="text" style="width: 2em"/> x 
                        	    <input id="space-vert" name="spaceVert" type="text" style="width: 2em"> ft
                    	    </div>
                	    </form>
            	    </div>
            	    <div class="ui-block-b">
            	        <h2>Matching Plants</h2>
                	    <ul data-role="listview" class="plant-list">
                	        <li><a href="javascript:;"></a></li>
                	    </ul>
            	    </div>
        	    </div>
        	</div><!-- /content -->

        </div><!-- /page -->

        <div data-role="page" id="add">

        	<div data-role="header">
        	    <a href="javascript:;" data-rel="back" data-icon="back">Back</a>
        		<h1 class="plant-detail-name">Tomato</h1>
        	</div><!-- /header -->

        	<div data-role="content">	
        	    <div class="ui-grid-a">
            	    <div class="ui-block-a">
            	        <h2>
            	            <span class="plant-detail-name">Tomato: </span>
            	            <select class="plant-variety-select" data-inline="true">
            	            </select>
            	        </h2>
            	        <p class="plant-detail-info">tomato infos!</p>
            	    </div>
            	    <div class="ui-block-b">
            	        <h2>Add to garden</h2>
            	        <form class="add-planting-form">
                    	    <div data-role="fieldcontain">
                    	        <legend>Add as</legend>
                	            <fieldset data-role="controlgroup" data-type="horizontal">
                	                <label for="fill-area">Fill area</label>
                	                <input id="fill-area" name="addby" value="fill-area" type="radio" checked="checked"/>
                	                <label for="single-plant">Single plant</label>
                	                <input id="single-plant" name="addby" value="single-plant" type="radio"/>
                	            </fieldset>
            	            </div>
                    	    <div data-role="fieldcontain">
                    	        <label>Plant as</label>
                	            <fieldset data-role="controlgroup" data-type="horizontal">
                	                <label for="seed">Seed</label>
                	                <input id="seed" name="plantas" value="seed" type="radio" checked="checked"/>
                	                <label for="start">Start</label>
                	                <input id="start" name="plantas" value="start" type="radio"/>
                	            </fieldset>
            	            </div>
            	            <div data-role="fieldcontain">
            	                <label for="plant-date">Plant date</label>
            	                <input id="plant-date" name="plantDate" type="text"/>
            	            </div>
            	            <div data-role="fieldcontain">
            	                <label for="harvest-date">Harvest date</label>
            	                <input id="harvest-date" name="harvestDate" type="text"/>
            	            </div>
            	            <div data-role="fieldcontain">
            	                <label for="source">Plant/seed source</label>
            	                <textarea id="source" name="source"></textarea>
            	            </div>
            	            <input type="hidden" name="plantName"/>
            	            <input type="hidden" name="plantVariety"/>
            	            <input type="submit" value="Add"/>
            	        </form>
            	    </div>
        	    </div>
        	</div><!-- /content -->
        	
        </div><!-- /page -->

        <div data-role="page" id="history">

        	<div data-role="header">
        	    <a href="javascript:;" data-rel="back" data-icon="back">Back</a>
        		<h1>History</h1>
        	</div><!-- /header -->

        	<div data-role="content">
        	    <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <form class="history-search-form">
                	        <div data-role="fieldcontain">
                    	        <label for="year" class="ui-hidden-accessible">Year</label>
                    	        <select id="year" name="year">
                                    <option>2012</option>
                                    <option>2011</option>
                                    <option>2010</option>
                    	        </select>
                	        </div>
                	        <div data-role="fieldcontain">
                    	        <input id="plantName" name="plantName" type="text" data-type="search" placeholder="Plant" style="width:100%"/>
                	        </div>
                        </form>
                        <ul data-role="listview" data-inset="true" class="history-list" style="margin-right: 20px">
                            <li data-role="list-divider">2012</li>
                            <li><a href="javascript:;">Radish, breakfast</a></li>
                        </ul>
                    </div>
            	    <div class="ui-block-b">
            	        <h2>My Notes: <span class="plant-name"></span></h2>
            	        <form>
                	        <div data-role="fieldcontain">
                    	        <label for="planted">Planted</label>
                    	        <input id="planted" name="plantDate" type="text"/>
                	        </div>
                	        <div data-role="fieldcontain">
                    	        <label for="harvest-date">Harvested</label>
                    	        <input id="harvest-date" name="harvestDate" type="text"/>
                	        </div>
                	        <div data-role="fieldcontain">
                    	        <label for="plant-source">Plant source</label>
                    	        <input id="plant-source" name="source" type="text"/>
                	        </div>
                	        <div data-role="fieldcontain">
                    	        <label for="planted-from">Planted from</label>
                    	        <input id="planted-from" name="plantas" type="text"/>
                	        </div>
                	        <div data-role="fieldcontain">
                    	        <label for="notes">Notes</label>
                    	        <textarea id="notes"></textarea>
                	        </div>
            	            <div class="star-rating">
            	                <img src="star-empty.png"/>
            	                <img src="star-empty.png"/>
            	                <img src="star-empty.png"/>
            	                <img src="star-empty.png"/>
            	            </div>
            	            <input type="hidden" name="rating"/>
            	        </form>
            	        <a href="javascript:;" class="plant-again-link" data-role="button" data-icon="plus">Plant Again</a>
            	        <h2>Plant Information</h2>
            	        <p>plant infos!</p>
                    </div>
                </div>
            </div>
        </div>

        <div data-role="page" id="calendar">

        	<div data-role="header">
        	    <a href="javascript:;" data-rel="back" data-icon="back">Back</a>
        		<h1>Calendar</h1>
        	</div><!-- /header -->

        	<div data-role="content">
                <ul data-role="listview" data-inset="true">
                    <li data-role="list-divider">April</li>
                    <li>Plant radishes</li>
                    <li>Plant radishes</li>
                    <li>Plant radishes</li>
                    <li data-role="list-divider">May</li>
                    <li>Plant radishes</li>
                    <li data-role="list-divider">June</li>
                    <li>Plant radishes</li>
                    <li data-role="list-divider">July</li>
                    <li>Plant radishes</li>
                    <li>Plant radishes</li>
                </ul>
            </div>
        </div>

    </body>
</html>
